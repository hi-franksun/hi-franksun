# 性能测试方案和流程

## 技术体系

- 压测体系
- 性能监控体系
- 性能刨析体系
- 性能测试实战
- 性能测试方案设计

## 性能测试需求

### 性能测试的目的

- 容量规划能力
- 系统风险识别
- 系统瓶颈识别
- 性能调优指导

### 性能测试价值

- 避免业务毁坏，毁坏了业务就完了
- 避免硬件浪费

### 性能测试与分析优化技能树

- 压力测试
- 监控分析工具
- 缓存、队列（Kafka、MQ）、web 服务器、容器化、编排、网格、大数据技术
- 代码调优
- 操作系统OS
- 数据库
- 存储：NySQL、Redis、Memcache
- 应用服务器、中间件：Tomcat、Ningx
- 网络
- 调用链路问题

## 常见的性能测试刨析

系统资源问题：CPU、内存、磁盘、网络
语言和代码：JVM等
框架问题：Spring Boot、GRPC

问题1：正则问题，正则匹配会导致性能飙升，JSON 的序列化和反序列化也会导致很多性能问题；
备注：Top -H -p pid、Pstack pid、Trace -p pid
备注：正则匹配和 JSON 序列化和反序列化都会导致性能问题

问题2：php 程序，php-fpm 内存增长，OOM 导致服务挂掉
原因：使用了某个第三方的 JSON 解析，但是第三方插件又内存泄漏问题
备注：第三方插件插件很坑

问题3：某次压力测试，CPU、内存、网络表现良好，但是响应号时非常久
原因：监控发现磁盘 IO 异常，追查日志级别发现是 Debug 级别，大量日志打印拖累性能；
备注：同步日志可能是潜在的性能杀手

问题4：某次压力，所有的指标都很良好，但是响应耗时非常久 
原因：查看 Nginx 日志，发现 request_time 较长，但是 upstream_response_time 实际较短
备注：

问题5：同样的并发 TPS，性能前期良好，后期数据库 CPU 飙升
原因：压测产生大量数据，数据增长会带来性能的损耗
备注：不合理分页，未作分页 limit，同一个请求将数据库的所有数据都查询了

问题6：稳定性测试，大并发 TPS，前期性能良好，分片缓存，在模拟缓存单点失效后大量的数据库穿透
原因：缓存不合理的分片策略，使用除模方式。导致大量的缓存统一时间失效；还有不合理的负载均衡算法也会导致类似的问题
备注：一般使用 Hash 解决缓存问题

问题7：稳定性测试，htto 入口流量仅仅是几百 QPS，但是下游的 RPC 服务挂了
原因：商户列表，for 循环调用下游解决，导致请求数百倍扩大
备注：使用 Batch 接口减轻压力，但是 Batch 接口也会导致很多功能隐患

## 流行的性能测试工具

目前流行的性能测试工具

- Apache AB
- Apache JMeter
- Locust
- 阿里 PTS

### Apache AB

全称：Apache HTTP server benchmarking tool

小快灵的工具，测试 http 协议，一般开发的时候简单调用的时候使用；

### JMeter

毫无疑问，这个就是目前最好的工具，开源，可以完成多种协议测试，提供插件系统，非常容易二次开发；

### Grinder

简单了解，主要使用 Python 脚本的方式调用 Java，完成压测；

### Locust

python 语言的压力测试工具，一般使用 docker 部署，形成一个大的并发；

### 功能选项

压测场景：单节口/复杂事务 --> AB/JMeter
压力需求：1千、1万、100万 --> 是否支持分布式
周期性：快速迭代 --> 是否能数据驱动，测试结果入库
二次开发：JMeter 开源插件思想，能否支持多种插件，能不能快速平台化，
社区：Apache 不用担心，同时大量公司使用，社区丰富

总结一下：就直接使用 JMeter 就可以了，完爆其他的工具，唯一例外就是需求量很低的情况下，不用使用 JMeter，比如单节口；

## 流行的性能监控工具

1. Linux 自带的 vmstat、top

2. 机器监控工具 mmon：一个整合的小型监控工具，可以导出图表，方便又数据

3. 物理机监控 Collectd + InfluxDB + Grafana
收集工具，会是一个守护进程，支持获取常用的指标，也可以测试数据持久化，一般结合其他软件使用，一般运维或者云平台，很多会使用这个工具，c编写的内存消耗也比较低；

4. Docker + MySQL + Redis 一体化监控：Prometheus + Grafana node_exporter,mysqld_exporter,redis_exporter,自定义Exporter，全家桶
Prometheus 是用 go 语言开发的，也是 Google 开源的工具，这个优势太大了！是 K8S 下的一个子项目，用于获取集群性能，

5. 全链路 Tracing 监控，Zipkin

## 性能测试刨析工具

系统级别：
代码级别：
DB 级别：
链路界别：
缓存：
队列：
负载均衡：
网络：
容器：
火焰图：
拆分火焰图：

## 性能测试方案

1. 性能测试方案设计（最重要）
  
    - 根据具体的性能测试需求，确定测试类型和压测的模块
    - 前期与相关人员充分沟通，一定要了解架构，初步确定压测方案和具体的性能指标
    - QA 完成性能测试设计后，需要产出测试方案文档发送邮件到项目组，并且再次与相关人员沟通（或者组织性能测试评审），确定是否满足需求（甩锅）；

2. 需求分析和测试设计
3. 环境设计和搭建
    - 测试数据的准备和构造
    - 请求接口参数，自己构造、日志获取、上下关联
    - 数据表的数据填充
    - 如果是多接口，需要结合业务场景设计请求比例
4. 测试数据准备
5. 性能指标预期
    - 事先确定好 pv，转换成每秒请求数（qps）
    - 请求响应时间（最大、最小、平均）
    - 错误率
    - 机器性能，CPU idle 30%，memory 无剧烈抖动或者飙升
    - 压测过程中接口功能是否正常
    - 不同的性能测试方式下指标预期会有差异
6. 发压工具配置和脚本编写
    - 发压准备：
    - JMter 准备，Java 环境，各种系统下可以通用（）
    - jmx 脚本为 xml 文件，各个系统可以查看
    - 多线程并发
    - 运行完脚本生成 jtl 日志，可以在各种系统中查看、统计
    - 脚本编写：http请求、socket 请求
    - 启动压力测试：jmeter -n -t hb.jmx -l hb.jtl
7. 测试过程
    - 测试前：环境检查、记录机器参数
    - 测试中：起亚，调节并发量到合适的情况
    - 查看记录各项性能指标
        - Nginx 日志查看每秒请求数
        - 查看 Nginx 错误请求书
        - 查看机器的参数：cpu、men等
        - 查看 db和 cache 写入数据是否正常，测试的目的还是业务要对，如果业务都不对，搞个屁
        - 访问接口，查看功能是否正常
8. 结果分析和测试报告
    - 根据各种数据和日志，进行分析，产生一个测试报告
    - 测试完成需要和相关人员沟通，查看是否满足需求
    - 发送测试报告邮件

## 全链路性能测试介绍

不做全链路压测，线上压测结果和线上的压测结果可能会不一致，很多配置和组合出来的测试结果不能完整的代表整个测试结果，有可能线下压测很好，但是上线就完了；

## 高楼老师观点

测试工具是用来发送压力的，一般只需要看 TPS 和 QPS
监控工具是用来获取数据的，分析才是最重要的

工具都不是最重要的，重要的是通过工具获得了什么东西，也就是我用这个工具的目的是而还是那么，而不是为了使用工具而使用工具；

调优的前提是先把压力起来，再调优，而不是没用上就调优，没用上调什么优化；

高楼老师的金句：
趋势、证据链（上下文）
在乎的是数据，不是数据的展示形式，不要沉迷在形式里，抓住本质
监控的时候，我们要知道原理是什么

### 代码级别的监控和刨析工具

代码级别监控工具没必要在第一个阶段就上，因为代码级别的监控工具会导致系统的性能下降，越小巧越好，一般会在第二个阶段上，第一个阶段找不到问题的时候再上，或者第一个阶段找不到原因的时候再上；

内存泄漏和内存溢出是完全按两个概念，内存溢出不是内存满了才会泄漏，不满的时候也会溢出，内存泄漏是新的对象没有被回收才会发生泄漏；

sql 级别不仅仅是慢查询，还有很多很多执行过程中的影响效率的地方，数据库的配置很重要；

工具只是一部分，最低级别的就是会使用，而高级别的就是知道底层的原理，不了解底层的原理是没有价值的；

链路级别的监控，也不是看炫酷，而是要抓住本质，数据、数据、数据！

